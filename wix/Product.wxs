<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <Package Name="skHost"
           Language="1033"
           Version="$(Version)"
           Manufacturer="SaltSpectre"
           UpgradeCode="89430433-beba-43a1-97a0-2689bcb98431"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perUser">

    <SummaryInformation Description="An idle prevention tool for local, RDP, RemoteApp, and Hyper-V sessions written entirely in PowerShell for maximum portability." />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <Feature Id="ProductFeature" 
             Title="skHost" 
             Level="1" 
             Display="expand" 
             ConfigurableDirectory="INSTALLFOLDER"
             AllowAbsent="no"
             AllowAdvertise="no"
             Description="The main skHost application (required).">
      <ComponentGroupRef Id="PublishedFiles" />
      <ComponentRef Id="ApplicationShortcutComponent" />
      
      <Feature Id="PathFeature" 
               Title="PATH Registration" 
               Level="1"
               AllowAdvertise="no"
               Description="Adds skHost to your PATH environment variable for easy command-line access.">
        <ComponentRef Id="PathEnvironmentComponent" />
      </Feature>
      
      <Feature Id="AutoStartFeature" 
               Title="Auto start at logon" 
               Level="1"
               AllowAdvertise="no"
               Description="Automatically starts skHost when you log in to Windows.">
        <ComponentRef Id="AutoStartComponent" />
      </Feature>
    </Feature>

    <Icon Id="ProductIcon" SourceFile="../skHost.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="ARPHELPLINK" Value="https://github.com/SaltSpectre/skHost" />

    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <ui:WixUI Id="WixUI_FeatureTree" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="ManufacturerFolder" Name="SaltSpectre">
        <Directory Id="INSTALLFOLDER" Name="skHost" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ManufacturerProgramsFolder" Name="SaltSpectre">
        <Directory Id="ApplicationProgramsFolder" Name="skHost" />
      </Directory>
    </StandardDirectory>

  </Package>

  <Fragment>
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcutComponent" Guid="B3A4C8D1-2E5F-4A6B-9C7D-8E1F2A3B4C5D">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="skHost"
                  Description="An idle prevention tool for local, RDP, RemoteApp, and Hyper-V sessions written entirely in PowerShell for maximum portability."
                  Target="[SystemFolder]conhost.exe"
                  Arguments="powershell.exe -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File &quot;[INSTALLFOLDER]skhost.ps1&quot;"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="ProductIcon" />
        <Shortcut Id="UninstallProduct"
                  Name="Uninstall skHost"
                  Description="Uninstalls skHost"
                  Target="[SystemFolder]msiexec.exe"
                  Arguments="/x [ProductCode]" />
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RemoveFolder Id="CleanUpManufacturerPrograms" Directory="ManufacturerProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU"
                       Key="Software\SaltSpectre\skHost"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="PathEnvironmentComponent" Guid="C5D6E7F8-9A0B-1C2D-3E4F-5A6B7C8D9E0F">
        <Environment Id="PathEnvironment"
                     Name="PATH"
                     Value="[INSTALLFOLDER]"
                     Permanent="no"
                     Part="last"
                     Action="set"
                     System="no" />
        <CreateFolder />
        <RegistryValue Root="HKCU"
                       Key="Software\SaltSpectre\skHost"
                       Name="PathSet"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="AutoStartComponent" Guid="D6E7F8A9-0B1C-2D3E-4F5A-6B7C8D9E0F1A">
        <RegistryValue Root="HKCU"
                       Key="Software\Microsoft\Windows\CurrentVersion\Run"
                       Name="skHost"
                       Type="string"
                       Value="conhost powershell.exe -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File &quot;[INSTALLFOLDER]skhost.ps1&quot;"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

</Wix>
